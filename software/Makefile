SHELL := /bin/bash
ROOT_DIR := $(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))
DOCKER_LOCK_FILE := "$(ROOT_DIR)/DOCKER_LOCK"

.PHONY: $(MAKECMDGOALS) check cmake make clean

# Always go to the targets check, cmake and make.
# "check" checks if the tf docker dev environment is installed and calls it
# "cmake" calls cmake and generates the Makefile
# "make" calls the Makefile generated by cmake with the CMD given to this Makefile
all $(MAKECMDGOALS): check cmake make

check:
# First we check if the BUILDING_IN_DOCKER temporary file is there and delete it.
# It might still be there if a PC crashed mid build or similar
	@if [ -f "$(DOCKER_LOCK_FILE)" ]; then \
		rm $(DOCKER_LOCK_FILE); \
	fi
# Then we check if bricklib is symlinked correctly
	@if [ ! -d "src/bricklib" ]; then \
		echo "Could not find bricklib. Please symlink bricklib into src/ folder."; \
		exit 1; \
	fi
# Then we check if docker is available and if the tf_build_environenment container
# is available. If both is the case, we start the docker container, call this
# Makefile in the docker container and write a temporary file
	@if command -v docker >/dev/null 2>&1 ; then \
		if [ $$(/usr/bin/docker images -q tf_build_environment) ]; then \
			echo "Using docker image to build."; \
			docker run \
			-v $(ROOT_DIR)/../:/master-brick -u $$(id -u):$$(id -g) \
			-v $(ROOT_DIR)/../../bricklib:/master-brick/software/src/bricklib -u $$(id -u):$$(id -g) \
			-ti tf_build_environment /bin/bash \
			-c "cd /master-brick/software/ ; make $(MAKECMDGOALS)"; \
			touch $(DOCKER_LOCK_FILE); \
		else \
			echo "No docker image found, using local toolchain."; \
		fi \
	fi

cmake:
# If there is the temporary file, we are currently outside of the docker container
# and the docker container is running. In this case we do nothing. Otherwise
# we generate a Makefile with cmake
	@if [ ! -f $(DOCKER_LOCK_FILE) ]; then \
		if [ ! -d "build/" ]; then \
			./generate_makefile; \
		fi \
	fi

make:
# If there is the temporary file, we are currently outside of the docker container
# and the docker container is running. In this case we delete the temporary file,
# since this is the last target run outside of the docker container.
# Otherwise we call the Makefile generated by cmake.
	@if [ ! -f $(DOCKER_LOCK_FILE) ]; then \
		cd build/; \
		make $(MAKECMDGOALS); \
	else \
		rm $(DOCKER_LOCK_FILE); \
	fi

clean:
# In case of a clean we just remove the whole build/ directory. Doesn't matter if
# if we are inside or outside of the docker container here.
	@rm -rf build/
